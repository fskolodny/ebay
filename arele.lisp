(defpackage #:arele
  (:use #:cl
	#:clog
	#:clog-gui
	#:mito
	)
  (:shadowing-import-from :sxql where order-by fields)
  (:export start-app))

(in-package :arele)

(deftable investor ()
  ((name :col-type (:varchar 128))

   (percentage :col-type :smallint))
  (:table-name "investors")
  )

(deftable item ()
  ((description :col-type (:varchar 128))
   )
  (:table-name "inventory")
  )

(deftable purchase ()
  ((investor :col-type investor)
   (item :col-type item)
   (date :col-type :datetime)
   (quantity :col-type :integer)
   (on-hand :col-type :integer)
   (price :col-type :integer)
   )
  (:table-name "purchases")
  )

(deftable listing ()
  ((purchase :col-type purchase)
   (date :col-type :datetime)
   (quantity :col-type :integer)
   (price :col-type :integer)
   )
  (:table-name "listings")
  )

(deftable sale ()
  ((listing :col-type listing)
   (date :col-type :datetime)
   (quantity :col-type :integer)
   (price :col-type :integer)
   (fees :col-type :integer)
   (shipping :col-type :integer)
   (customer :col-type (:varchar 128))
   )
  (:table-name "sales")
  )

(deftable remittance ()
  ((investor :col-type investor)
   (date :col-type :datetime)
   (amount :col-type :integer)
   )
  (:table-name "remittances")
  )

(defun to-dollar (value)
  (multiple-value-bind (x result) (ppcre:scan-to-strings "(\\d+)(.(\\d{2}))?" value)
    (declare (ignore x))
    (+ (* 100 (parse-integer (or (aref result 0) "0"))) (parse-integer (or (aref result 2) "0")))
    )
  )

(defun display-dollar (value)
  (format nil "~$" value)
  )

(defun add-investor (&key name percentage)
  (create-dao 'investor :name name :percentage percentage)
  )

(defun add-inventory-item (&key description &allow-other-keys)
  (create-dao 'item :description description)
  )

(defun add-purchase (&key item date quantity price investor &allow-other-keys)
  (create-dao 'purchase :item item :date date :quantity quantity :on-hand quantity :price price :investor investor)
  )

(defun add-listing (&key purchase date quantity price &allow-other-keys)
  (setf (purchase-on-hand purchase) (- (purchase-on-hand purchase) quantity))
  (update-dao purchase)
  (create-dao 'listing :purchase purchase :date date :quantity quantity :price price)
  )

(defun add-sale (&key listing date quantity price fees shipping customer)
  (setf (listing-quantity listing) (- (listing-quantity listing) quantity))
  (create-dao 'sale :listing listing :date date :quantity quantity :price price :fees fees
		    :shipping shipping :customer customer)
  (update-dao listing)
  )

(defun update-shipping (&key sale shipping &allow-other-keys)
  (setf (sale-shipping sale) shipping)
  (update-dao sale)
  )

(defun add-remittance (&key investor date amount &allow-other-keys)
  (create-dao 'remittance :investor investor :date date :amount amount)
  )

(defun on-investor-list (obj)
  (let* ((app (connection-data-item obj "app-data"))
         (win (create-gui-window obj :title "Investors"))
         (panel (create-div (window-content win)))
	 (slots '(:id :name :percentage))
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(table (:bind table)
	       (table-head (:bind th)
			      )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute table :border) 1)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    slots)
      (mapc (lambda (investor)
	      (with-clog-create tb
		  (table-row (:bind tr)
			     )
		(create-table-column tr :content (object-id investor))
		(create-table-column tr :content (investor-name investor))
		(create-table-column tr :content (investor-percentage investor))
		)
	      )
	    (retrieve-dao 'investor)
	    )
      )
    )
  )

(defun on-add-investor (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Investor" :width 400 :height 400))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignore app))
    (with-clog-create panel
	(span ()
	      (form (:bind f1)
		    (table ()
			   (table-body ()
				       (table-row ()
						  (table-column () (label (:content "Name")))
						  (table-column () (form-element (:bind name :text)))
						  )
				       (table-row ()
						  (table-column () (label (:content "Percentage 0-100")))
						  (table-column () (select (:bind percentage)
								     (option (:value 0 :content 0))
								     (option (:value 30 :content 30 :selected t))
								     (option (:value 100 :content 100))
								     ))
						  )
				       (table-row ()
						  (table-column () (form-element (:submit :value "Submit")))
						  (table-column () (form-element (:reset :value "Reset")))
						  )
				       )
			   )
		    )
	      (div (:bind msg :content "Successfully added."))
	      )
      (setf (attribute name :required) t
	    (attribute percentage :required) t
	    (attribute msg :hidden) t
	    )
      (set-on-submit f1 (lambda (obj)
			  (declare (ignorable obj))
			  (add-investor :name (value name) :percentage (parse-integer (value percentage)))
			  (setf (attribute msg :hidden) nil)
			  )
		     )
      )
    )
  )

(defun on-inventory-list (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Inventory"))
	 (inventory (create-div (window-content win)))
	 (slots '(:id :description))
	 )
    (declare (ignorable app inventory))
    (with-clog-create inventory
	(table (:bind table)
	       (table-head (:bind th)
			      )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute table :border) 1)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    slots)
      (mapc (lambda (item)
	      (with-clog-create tb
		  (table-row (:bind tr)
			     )
		(create-table-column tr :content (object-id item))
		(create-table-column tr :content (item-description item))
		)
	      )
	    (retrieve-dao 'item)
	    )
      )
    )
  )

(defun on-add-item (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Item"))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignore app))
    (with-clog-create panel
	(form (:bind f1)
	      (fieldset (:bind fs1)
			(table ()
			       (table-body ()
					   (table-row ()
						      (table-column () (label (:content "Description")))
						      (table-column () (form-element (:bind description :text)))
						      )
					   (table-row ()
						      (table-column () (form-element (:submit :value "Ok")))
						      (table-column () (form-element (:reset :value "Clear")))
						      )
					   )
			       )
			)
	      )
      (setf (attribute description :requiredp) t)
      (set-on-submit f1 (lambda (obj)
			  (declare (ignore obj))
			  (add-inventory-item :description (value description))
			  (setf (attribute f1 :hidden) t)
			  )
		     )
      )
    )
  )

(defun on-purchases-list (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Purchases" :width 1200))
	 (purchases (create-div (window-content win)))
	 (slots '(:id :investor :item :date :quantity :on-hand))
	 (dollar-slots '(:price))
	 )
    (declare (ignorable app purchases))
    (with-clog-create purchases
	(table (:bind table)
	       (table-head (:bind th)
			      )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute table :border) 1)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    slots)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    dollar-slots)
      (mapc (lambda (purchase)
	      (with-clog-create tb
		  (table-row (:bind tr)
			     )
		(create-table-column tr :content (object-id purchase))
		(create-table-column tr :content (investor-name (purchase-investor purchase)))
		(create-table-column tr :content (item-description (purchase-item purchase)))
		(create-table-column tr :content (purchase-date purchase))
		(create-table-column tr :content (purchase-quantity purchase))
		(create-table-column tr :content (purchase-on-hand purchase))
		(create-table-column tr :content (display-dollar (/ (purchase-price purchase) 100)))
		)
	      )
	    (retrieve-dao 'purchase)
	    )
      )
    )
  )

(defun on-add-purchase (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Purchase" :height 600))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(div ()
	     (form (:bind f1)
		   (table (:bind tbl)
			  (table-body ()
				      (table-row ()
						 (table-column () (label (:content "Select item")))
						 (table-column () (select (:bind item)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Date")))
						 (table-column () (form-element (:bind date :date)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Price")))
						 (table-column () (form-element (:bind price :text)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Quantity")))
						 (table-column () (form-element (:bind quantity :number)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Select investor")))
						 (table-column () (select (:bind investor)))
						 )
				      (table-row ()
						 (table-column () (form-element (:submit :value "Ok")))
						 (table-column () (form-element (:reset :value "Clear")))
						 )
				      )
			     )
		   )
	     )
      (mapcar (lambda (i)
		(add-select-option item (object-id i) (item-description i)))
	      (retrieve-dao 'item)
	      )
      (mapcar (lambda (i)
		(add-select-option investor (object-id i) (investor-name i)))
	      (retrieve-dao 'investor)
	      )
      (setf (attribute price :pattern) "\\d+([.]\\d\\d)?"
	    (attribute date :required) t
	    (attribute item :required) t
	    (attribute price :required) t
	    (attribute quantity :required) t
	    (minimum quantity) 1
	    (attribute investor :required) t
	    )
      
      (set-on-submit f1
		     (lambda (obj)
		       (declare (ignore obj))
		       (add-purchase :item (find-dao 'item :id (value item))
				     :date (value date) :quantity (value quantity) :price (to-dollar (value price))
				     :investor (find-dao 'investor :id (value investor)))
		       (setf (attribute f1 :hidden) t)
		       )
		     )
      )
    )
  )

(defun on-listings-list (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Listings" :width 1200))
	 (listings (create-div (window-content win)))
	 (slots '(:id :item :investor :date :quantity))
	 (dollar-slots '(:price))
	 )
    (declare (ignorable app))
    (with-clog-create listings
	(table (:bind table)
	       (table-head (:bind th)
			      )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute table :border) 1)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    slots)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    dollar-slots)
      (mapc (lambda (listing)
	      (with-clog-create tb
		  (table-row (:bind tr)
			     )
		(create-table-column tr :content (object-id listing))
		(let ((purchase (listing-purchase listing))
		      )
		  (create-table-column tr :content (item-description (purchase-item purchase)))
		  (create-table-column tr :content (investor-name (purchase-investor purchase)))
		  )
		(create-table-column tr :content (listing-date listing))
		(create-table-column tr :content (listing-quantity listing))
		(create-table-column tr :content (display-dollar (/ (listing-price listing) 100)))
		)
	      )
	    (retrieve-dao 'listing)
	    )
      )
    )
  )
(defun on-add-listing (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Listing" :height 600))
	 (panel (create-div (window-content win)))
	 (max)
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(div ()
	     (form (:bind f1)
		   (table (:bind tbl)
			  (table-body ()
				      (table-row ()
						 (table-column () (label (:content "Select item")))
						 (table-column () (select (:bind item)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Date")))
						 (table-column () (form-element (:bind date :date)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Price")))
						 (table-column () (form-element (:bind price :text)))
						 )
				      (table-row ()
						 (table-column () (label (:content "Quantity")))
						 (table-column () (form-element (:bind quantity :number)))
						 )
				      (table-row ()
						 (table-column () (form-element (:submit :value "Ok")))
						 (table-column () (form-element (:reset :value "Clear")))
						 )
				      )
			     )
		   )
	     )
      (mapcar (lambda (i)
		(add-select-option item (object-id i) (item-description i)))
	      (retrieve-dao 'item)
	      )
      (setf (attribute price :pattern) "\\d+(.\d\d)?"
	    (attribute item :required) t
	    (attribute price :required) t
	    (attribute date :required) t
	    (attribute quantity :required) t
	    (minimum quantity) 1
	    )
      (set-on-submit f1
		     (lambda (obj)
		       (declare (ignore obj))
		       (let ((q (parse-integer (value quantity)))
			     )
			 (setf max (or (getf (first (retrieve-by-sql (sxql:select (sxql:fields (:as (:max :on_hand) :on-hand))
								       (sxql:from :purchases) (where (:= :item_id (value item)))))) :on-hand) 0))
			 (if (<= 1 q max)
			     (let ((purchases (select-dao 'purchase
						(where (:and (:= :item_id (value item)) (:>= :on_hand q)))
						(order-by :date)))
				   )
			       (when (first purchases)
				 (add-listing :purchase (first purchases) :date (value date) :quantity q :price (to-dollar (value price)))
				 )
			       )
			     )
			 )
		       )
		     )
      )
    )
  )

(defun on-sales-list (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "List Sales" :width 1200))
	 (panel (create-div (window-content win)))
	 (slots '(:id :date :quantity :customer :investor :item))
	 (dollar-slots '(:price :fees :shipping))
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(table (:bind table)
	       (table-head (:bind th)
			      )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute table :border) 1)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    slots)
      (mapc (lambda (slot)
	      (create-table-column th :content (format nil "~:(~a~)" slot))
	      )
	    dollar-slots)
      (mapc (lambda (sale)
	      (with-clog-create tb
		  (table-row (:bind tr)
			     )
		(create-table-column tr :content (object-id sale))
		(create-table-column tr :content (sale-date sale))
		(create-table-column tr :content (sale-quantity sale))
		(create-table-column tr :content (sale-customer sale))
		(create-table-column tr :content (investor-name (purchase-investor (listing-purchase (sale-listing sale)))))
		(create-table-column tr :content (item-description (purchase-item (listing-purchase (sale-listing sale)))))
		(create-table-column tr :content (display-dollar (/ (sale-price sale) 100)))
		(create-table-column tr :content (display-dollar (/ (sale-fees sale) 100)))
		(create-table-column tr :content (display-dollar (/ (sale-shipping sale) 100)))
		)
	      )
	    (retrieve-dao 'sale)
	    )
      )
    )
  )

(defun on-add-sale (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Sale" :height 600))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(form (:bind f1)
	      (table ()
		     (table-body ()
				 (table-row ()
					    (table-column () (label (:content "Select listing")))
					    (table-column () (select (:bind listing)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Date")))
					    (table-column () (form-element (:bind date :date)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Quantity")))
					    (table-column () (form-element (:bind quantity :number)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Price")))
					    (table-column () (form-element (:bind price :text)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Fees")))
					    (table-column () (form-element (:bind fees :text)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Shipping")))
					    (table-column () (form-element (:bind shipping :text)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Customer")))
					    (table-column () (form-element (:bind customer :text)))
					    )
				 (table-row ()
					    (table-column () (form-element (:submit :value "Ok")))
					    (table-column () (form-element (:reset :value "Reset")))
					    )
				 )
		     )
	      )
      (declare (ignorable date quantity price fees shipping customer))
      (mapc (lambda (l)
	      (add-select-option listing (object-id l) (format nil "~a ~a ~a" (listing-date l) (item-description (purchase-item (listing-purchase l))) (listing-quantity l)))
	      )
	    (retrieve-dao 'listing)
	    )
      (setf (attribute price :pattern) "\\d+([.].\\d\\d)?"
	    (attribute fees :pattern) "\\d+([.]\\d\\d)?"
	    (attribute shipping :pattern) "\\d+([.]\\d\\d)?"
	    (attribute listing :required) t
	    (attribute date :required) t
	    (attribute quantity :required) t
	    (attribute price :required) t
	    (attribute fees :required) t
	    (attribute customer :required) t
	    )
      (set-on-submit f1 (lambda (obj)
			  (declare (ignore obj))
			  (let* ((listing (find-dao 'listing :id (value listing)))
				 )
			    (when (<= 1 (parse-integer (value quantity)) (listing-quantity listing))
			      (add-sale :listing listing :date (value date) :quantity (parse-integer (value quantity)) :customer (value customer)
					:price (to-dollar (value price)) :fees (to-dollar (value fees))	:shipping (to-dollar (or (value shipping) "0")))
			      )
			    )
			  )
		     )
      )
    )
  )

(defun on-update-shipping (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Update Shipping"))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignore app))
    (with-clog-create panel
	(form (:bind f1)
	      (table ()
		     (table-body ()
				 (table-row ()
					    (table-column () (label (:content "Select sale")))
					    (table-column () (select (:bind sale)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Shipping")))
					    (table-column () (form-element (:bind shipping :text)))
					    )
				 (table-row ()
					    (table-column () (form-element (:submit :value "Ok")))
					    (table-column () (form-element (:reset :value "Reset")))
					    )
				 )
		     )
	      )
      (mapc (lambda (s)
	      (add-select-option sale (object-id s) (format nil "~a ~a ~a" (sale-date s) (item-description (purchase-item (listing-purchase (sale-listing s)))) (sale-quantity s)))
	      )
	    (retrieve-dao 'sale)
	    )
      (setf (attribute shipping :pattern) "\\d+([.]\\d\\d)?"
	    (attribute sale :required) t
	    (attribute shipping :required) t
	    )
      (set-on-submit f1 (lambda (obj)
			  (declare (ignore obj))
			  (update-shipping :sale (find-dao 'sale :id (value sale)) :shipping (to-dollar (value shipping)))
			  (reset f1)
			  )
		     )
	)
    )
  )

(defun on-amounts-due (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Amounts Due"))
	 (panel (create-div (window-content win)))
	 (encumbered 0)
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(table (:bind tbl)
	       (table-head (:bind th)
			   )
	       (table-body (:bind tb)
			   )
	       )
      (setf (attribute tbl :border) 1)
      (mapc (lambda (name)
	      (create-table-column th :content (format nil "~:(~a~)" name))
	      )
	    '(:name :|amount due| :remitted)
	    )
      (mapc (lambda (investor)
		(unless (zerop (investor-percentage investor))
		  (let ((tr (create-table-row tb))
			(amount-due 0)
			)
		    (create-table-column tr :content (investor-name investor))
		    (mapc (lambda (purchase)
			    (let* ((unit-price (/ (purchase-price purchase) (purchase-quantity purchase)))
				   (cost-on-hand (* unit-price (purchase-on-hand purchase)))
				   )
			      (setf encumbered (+ encumbered cost-on-hand))
			      (mapc (lambda (listing)
				      (mapc (lambda (sale)
					      (declare (ignorable sale))
					      (let* ((cost-of-goods (* unit-price (sale-quantity sale)))
						     (profit (- (sale-price sale) cost-of-goods (or (sale-fees sale) 0) (or (sale-shipping sale) 0)))
						     (to-be-remitted)
						     )
						(if (eql (investor-percentage investor) 30)
						    (setf to-be-remitted (+ cost-of-goods (* 30/100 (min profit cost-of-goods)) (* 50/100 (max 0 (- profit cost-of-goods)))))
						    (setf to-be-remitted (+ cost-of-goods profit))
						    )
						(incf encumbered to-be-remitted)
						(incf amount-due to-be-remitted)
						)
					      )
					    (select-dao 'sale (where (:= :listing_id (object-id listing))))
					    )
				      )
				    (select-dao 'listing (where (:= :purchase_id (object-id purchase))))
				    )
			      )
			    )
			  (select-dao 'purchase (where (:= :investor_id (object-id investor))))
			  )
		    (create-table-column tr :content (display-dollar (/ amount-due 100)))
		    (create-table-column tr :content (display-dollar (/ (or (getf (first (retrieve-by-sql (sxql:select (sxql:fields (:as (:sum :amount) :amount))
													    (sxql:from :remittances) (where (:= :investor_id (object-id investor)))))) :amount) 0) 100)))
		    )
	      )
	    )
	    (retrieve-dao 'investor)
	    )
      )
    (create-div panel :content (format nil "Amount encumbered is ~a." (display-dollar (/ encumbered 100))))
    )
  )

(defun on-add-remittance (obj)
  (let* ((app (connection-data-item obj "app-data"))
	 (win (create-gui-window obj :title "Add Sale" :height 600))
	 (panel (create-div (window-content win)))
	 )
    (declare (ignorable app))
    (with-clog-create panel
	(form (:bind f1)
	      (table ()
		     (table-body ()
				 (table-row ()
					    (table-column () (label (:content "Select investor")))
					    (table-column () (select (:bind investor)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Date")))
					    (table-column () (form-element (:bind date :date)))
					    )
				 (table-row ()
					    (table-column () (label (:content "Amount")))
					    (table-column () (form-element (:bind amount :text)))
					    )
				 (table-row ()
					    (table-column () (form-element (:submit :value "Ok")))
					    (table-column () (form-element (:reset :value "Reset")))
					    )
				 )
		     )
	      )
      (mapc (lambda (i)
	      (add-select-option investor (object-id i) (investor-name i))
	      )
	    (retrieve-dao 'investor)
	    )
      (setf (attribute investor :required) t
	    (attribute date :required) t
	    (attribute amount :required) t
	    (attribute amount :pattern) "\\d+(.\d\d)?"
	    )
      (set-on-submit f1 (lambda (obj)
			  (declare (ignore obj))
			  (add-remittance :investor (first (select-dao 'investor (where (:= :id (value investor)))))
					  :date (value date) :amount (to-dollar (value amount)))
			  (reset f1)
			  )
		     )
      )
    )
  )
(defun on-help-about (obj)
  (let* ((about (create-gui-window obj
                                   :title   "About"
                                   :content "<div class='w3-black'>
                                         <center><img src='/img/clogwicon.png'></center>
                                         <center>arele</center>
                                         <center>arele</center></div>
                                         <div><p><center>A New App</center>
                                         <center>(c) 2023 - Fila Kolodny</center></p></div>"
                                   :hidden  t
                                   :width   200
                                   :height  200)))
    (window-center about)
    (setf (visiblep about) t)
    (set-on-window-can-size about (lambda (obj)
                                    (declare (ignore obj))()))))

(defclass app-data ()
  ((data
    :accessor data)))

(defun on-new-window (body)
  (let ((app (make-instance 'app-data)))
    (setf (connection-data-item body "app-data") app)
    (setf (title (html-document body)) "EBay Store Software")
    (clog-gui-initialize body)
    (add-class body "w3-teal")
    (connect-toplevel :sqlite3 :database-name "arele.db")
    (with-clog-create body
	(gui-menu-bar (:bind menu-bar)
		  (gui-menu-drop-down (:content "Investors")
				      (gui-menu-item (:content "Investor List" :on-click 'on-investor-list))
				      (gui-menu-item (:content "Add Investor" :on-click 'on-add-investor))
				      )
		  (gui-menu-drop-down (:content "Inventory")
				      (gui-menu-item (:content "Items" :on-click 'on-inventory-list))
				      (gui-menu-item (:content "Add Item" :on-click 'on-add-item))
				      )
		  (gui-menu-drop-down (:content "Purchases")
				      (gui-menu-item (:content "Purchases List" :on-click 'on-purchases-list))
				      (gui-menu-item (:content "Add Purchase" :on-click 'on-add-purchase))
				      )
		  (gui-menu-drop-down (:content "Listings")
				      (gui-menu-item (:content "Listings List" :on-click 'on-listings-list))
				      (gui-menu-item (:content "Add Listing" :on-click 'on-add-listing))
				      )
		  (gui-menu-drop-down (:content "Sales")
				      (gui-menu-item (:content "Sales List" :on-click 'on-sales-list))
				      (gui-menu-item (:content "Add Sale" :on-click 'on-add-sale))
				      (gui-menu-item (:content "Update Shipping" :on-click 'on-update-shipping))
				      )
		  (gui-menu-drop-down (:content "Remittances")
				      (gui-menu-item (:content "Add remittance" :on-click 'on-add-remittance))
				      )
		  (gui-menu-drop-down (:content "Reports")
				      (gui-menu-item (:content "Amounts due" :on-click 'on-amounts-due))
				      (gui-menu-item (:content "Investor List" :on-click 'on-investor-list))
				      (gui-menu-item (:content "Inventory items" :on-click 'on-inventory-list))
				      (gui-menu-item (:content "Purchases List" :on-click 'on-purchases-list))
				      (gui-menu-item (:content "Listings List" :on-click 'on-listings-list))
				      (gui-menu-item (:content "Sales List" :on-click 'on-sales-list))
				      )
		  (gui-menu-drop-down (:content "Help")
				      (gui-menu-item (:content "About" :on-click 'on-help-about))
				      )
		  )
      (create-gui-menu-full-screen menu-bar)
      )
    )
  )

(defun start-app ()
  (initialize 'on-new-window
   :static-root (merge-pathnames "./www/"
                  (asdf:system-source-directory :arele)))
  (open-browser))
